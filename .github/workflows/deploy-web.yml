name: Deploy Web to EAS

on:
  push:
    branches:
      - "main"
  workflow_dispatch:
    # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Production
    steps:
      - name: ðŸ— Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ— Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: ðŸ— Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ“¦ Install dependencies
        working-directory: mobile
        run: npm ci

      - name: âœ… Pre-deployment validation
        working-directory: mobile
        run: |
          echo "ðŸ” Running pre-deployment checks..."
          
          # Check for required environment variables
          if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "âŒ EXPO_TOKEN secret is not set"
            exit 1
          fi
          
          # Type check (if TypeScript is configured)
          if [ -f "tsconfig.json" ]; then
            echo "ðŸ“ Running TypeScript type check..."
            npx tsc --noEmit || {
              echo "âŒ TypeScript type check failed"
              exit 1
            }
          fi
          
          # Verify package.json scripts exist
          if ! grep -q '"deploy:web"' package.json; then
            echo "âŒ deploy:web script not found in package.json"
            exit 1
          fi
          
          echo "âœ… Pre-deployment validation passed"

      - name: ðŸš€ Export and Deploy Web
        working-directory: mobile
        run: npm run deploy:web
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ¥ Post-deployment health check
        run: |
          echo "ðŸ¥ Running post-deployment health checks..."
          
          # Note: EAS deployment URL would need to be retrieved from deployment output
          # For now, we'll just verify the deployment completed successfully
          echo "âœ… Deployment completed. Please verify the web app is accessible."
          echo ""
          echo "**Next steps:**"
          echo "1. Verify the web app loads correctly"
          echo "2. Test key user flows (auth, groups, transactions)"
          echo "3. Check browser console for any errors"
          
          # Add deployment summary
          echo "## âœ… Web Deployment Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The web application has been deployed to production via EAS." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Please verify:**" >> $GITHUB_STEP_SUMMARY
          echo "- Web app is accessible" >> $GITHUB_STEP_SUMMARY
          echo "- Authentication works correctly" >> $GITHUB_STEP_SUMMARY
          echo "- Layout respects max-width on desktop" >> $GITHUB_STEP_SUMMARY
          echo "- Modals are centered and properly sized" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true
