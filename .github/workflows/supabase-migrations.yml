name: Apply Supabase Migrations

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  migrate:
    name: Run migrations against Supabase
    runs-on: ubuntu-latest
    environment: Production
    env:
      SUPABASE_DATABASE_URL: ${{ secrets.SUPABASE_DATABASE_URL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Prepare database URL (ensure SSL)
        run: |
          python3 << 'EOF'
          import os
          import sys
          import urllib.parse
          
          url = os.environ.get("SUPABASE_DATABASE_URL")
          if not url:
              print("ERROR: SUPABASE_DATABASE_URL secret is not set", file=sys.stderr)
              sys.exit(1)
          
          parsed = urllib.parse.urlparse(url)
          hostname = parsed.hostname or ""
          
          # Check if user provided direct database URL instead of pooler URL
          if hostname.startswith("db.") and hostname.endswith(".supabase.co"):
              print("ERROR: Direct database connection detected!", file=sys.stderr)
              print("", file=sys.stderr)
              print("You must use the CONNECTION POOLER URL, not the direct database URL.", file=sys.stderr)
              print("", file=sys.stderr)
              print("To get the pooler URL:", file=sys.stderr)
              print("1. Go to your Supabase project dashboard", file=sys.stderr)
              print("2. Navigate to Settings > Database", file=sys.stderr)
              print("3. Under 'Connection string', select 'Session mode' or 'Transaction mode'", file=sys.stderr)
              print("4. Copy the 'Connection pooling' string (port 6543)", file=sys.stderr)
              print("5. It should look like: postgresql://postgres.[PROJECT-REF]:[PASSWORD]@aws-0-[REGION].pooler.supabase.com:6543/postgres", file=sys.stderr)
              print("6. Update the SUPABASE_DATABASE_URL secret with this pooler URL", file=sys.stderr)
              sys.exit(1)
          
          # Ensure sslmode=require is set
          query = urllib.parse.parse_qs(parsed.query)
          if "sslmode" not in query:
              query["sslmode"] = ["require"]
          new_query = urllib.parse.urlencode(query, doseq=True)
          
          new_url = urllib.parse.urlunparse(
              (parsed.scheme, parsed.netloc, parsed.path, parsed.params, new_query, parsed.fragment)
          )
          
          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as env_file:
              env_file.write(f"DATABASE_URL={new_url}\n")
          
          print("✅ DATABASE_URL prepared with SSL requirement.")
          EOF

      - name: Verify database URL
        run: |
          if [ -z "${DATABASE_URL}" ]; then
            echo "DATABASE_URL is not set. Ensure SUPABASE_DATABASE_URL secret exists." >&2
            exit 1
          fi
          echo "DATABASE_URL is configured (redacted for logs)."

      - name: Show migrations dir (validation)
        run: |
          echo "Repo root listing:"
          ls -la
          echo "migrations folder listing (if exists):"
          if [ -d "./supabase/migrations" ]; then
            ls -la ./supabase/migrations || true
          else
            echo "No supabase/migrations folder found."
          fi

      - name: Run explicit migrations
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: |
          set -e
          
          # Install PostgreSQL client
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client
          
          if [ -d "./supabase/migrations" ]; then
            echo "Applying migrations from ./supabase/migrations ..."
            echo ""
            
            # List existing migrations in database
            echo "Checking existing migrations..."
            psql "${DATABASE_URL}" -c "SELECT version, name FROM supabase_migrations.schema_migrations ORDER BY version;" || echo "No migrations table yet (this is normal for first run)"
            echo ""
            
            # Apply each migration file that hasn't been applied yet
            for migration_file in ./supabase/migrations/*.sql; do
              if [ -f "$migration_file" ]; then
                filename=$(basename "$migration_file")
                version="${filename%%_*}"
                
                echo "Processing migration: $filename"
                
                # Check if this migration has already been applied
                EXISTS=$(psql "${DATABASE_URL}" -t -c "SELECT COUNT(*) FROM supabase_migrations.schema_migrations WHERE version = '$version';" 2>/dev/null || echo "0")
                
                if [ "$EXISTS" -eq "0" ]; then
                  echo "  → Applying migration $version..."
                  psql "${DATABASE_URL}" -f "$migration_file"
                  echo "  ✅ Migration $version applied successfully"
                else
                  echo "  ⏭️  Migration $version already applied, skipping"
                fi
                echo ""
              fi
            done
            
            echo "✅ All migrations processed"
          else
            echo "No supabase/migrations folder found; skipping migrations."
          fi

      - name: Post-check (validate connection)
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client
          PGCLIENTENCODING=UTF8 psql "${DATABASE_URL}" -c "SELECT version();" || echo "psql query failed (might be expected if DB blocks direct connections)."

      - name: Success
        run: echo "Migrations job finished."
