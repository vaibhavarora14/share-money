name: Deploy Supabase Edge Functions

on:
  push:
    branches:
      - "main"
  workflow_dispatch:
    # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Production
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify Supabase CLI
        run: |
          supabase --version
          echo "âœ… Supabase CLI installed successfully"

      - name: Verify required secrets
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "âŒ SUPABASE_ACCESS_TOKEN secret is not set"
            echo "Please add it in: Settings > Secrets and variables > Actions"
            exit 1
          fi
          if [ -z "$SUPABASE_PROJECT_REF" ]; then
            echo "âŒ SUPABASE_PROJECT_REF secret is not set"
            echo "Please add it in: Settings > Secrets and variables > Actions"
            echo "You can find your Project ID in your Supabase project settings"
            exit 1
          fi
          echo "âœ… Required secrets are configured"
          
          # Validate environment variable configuration
          echo ""
          echo "âš ï¸  IMPORTANT: Ensure ALLOWED_ORIGIN is set in Supabase project settings"
          echo "   This is critical for CORS security. Set it in:"
          echo "   Supabase Dashboard > Project Settings > Edge Functions > Environment Variables"
          echo ""
          echo "   Example: https://yourdomain.com,https://www.yourdomain.com"
          echo "   Never use '*' in production!"

      - name: âœ… Pre-deployment validation
        run: |
          echo "ðŸ” Running pre-deployment checks..."
          
          # Verify edge functions directory exists
          if [ ! -d "supabase/functions" ]; then
            echo "âŒ supabase/functions directory not found"
            exit 1
          fi
          
          # Check for required shared utilities
          if [ ! -f "supabase/functions/_shared/cors.ts" ]; then
            echo "âŒ CORS utility not found. This is required for security."
            exit 1
          fi
          
          # Verify all edge functions have proper structure
          echo "ðŸ“‹ Validating edge function structure..."
          for func_dir in supabase/functions/*/; do
            if [ -d "$func_dir" ] && [ "$(basename "$func_dir")" != "_shared" ]; then
              func_name=$(basename "$func_dir")
              if [ ! -f "$func_dir/index.ts" ]; then
                echo "âš ï¸  Warning: $func_name/index.ts not found"
              else
                echo "  âœ… $func_name/index.ts exists"
              fi
            fi
          done
          
          echo "âœ… Pre-deployment validation passed"

      - name: Link to Supabase project
        run: |
          supabase link --project-ref $SUPABASE_PROJECT_REF
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy all Edge Functions
        run: |
          echo "ðŸš€ Deploying Supabase Edge Functions..."
          supabase functions deploy --project-ref $SUPABASE_PROJECT_REF
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: ðŸ¥ Post-deployment health check
        run: |
          echo "ðŸ¥ Running post-deployment health checks..."
          
          # Get Supabase project URL (construct from project ref)
          SUPABASE_URL="https://$SUPABASE_PROJECT_REF.supabase.co"
          
          echo "ðŸ“‹ Testing deployed functions..."
          echo "Project URL: $SUPABASE_URL"
          echo ""
          
          # List of functions to check
          FUNCTIONS=("groups" "transactions" "balances" "settlements" "invitations" "group-members" "activity" "profile")
          
          echo "**Function Health Status:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for func in "${FUNCTIONS[@]}"; do
            echo "Testing $func..."
            # Test OPTIONS preflight (should return 200/204)
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -X OPTIONS \
              "$SUPABASE_URL/functions/v1/$func" \
              -H "Origin: https://example.com" \
              -H "Access-Control-Request-Method: GET" || echo "000")
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "204" ]; then
              echo "  âœ… $func: OPTIONS preflight working (HTTP $HTTP_CODE)"
              echo "âœ… $func - OPTIONS preflight: OK" >> $GITHUB_STEP_SUMMARY
            else
              echo "  âš ï¸  $func: OPTIONS preflight returned HTTP $HTTP_CODE (may need ALLOWED_ORIGIN configured)"
              echo "âš ï¸  $func - OPTIONS preflight: HTTP $HTTP_CODE (check CORS config)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify ALLOWED_ORIGIN is set in Supabase project settings" >> $GITHUB_STEP_SUMMARY
          echo "2. Test actual API calls from your web app" >> $GITHUB_STEP_SUMMARY
          echo "3. Check browser console for CORS errors" >> $GITHUB_STEP_SUMMARY
          
          echo ""
          echo "âœ… Health checks completed. Review results above."
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        continue-on-error: true

      - name: List deployed functions
        run: |
          echo "ðŸ“‹ Deployed Edge Functions:"
          supabase functions list --project-ref $SUPABASE_PROJECT_REF || echo "Note: Function listing may require additional permissions"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        continue-on-error: true

      - name: Deployment summary
        run: |
          echo "## âœ… Edge Functions Deployed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Supabase Edge Functions have been deployed to production." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed Functions:**" >> $GITHUB_STEP_SUMMARY
          echo "- activity" >> $GITHUB_STEP_SUMMARY
          echo "- balances" >> $GITHUB_STEP_SUMMARY
          echo "- group-members" >> $GITHUB_STEP_SUMMARY
          echo "- groups" >> $GITHUB_STEP_SUMMARY
          echo "- invitations" >> $GITHUB_STEP_SUMMARY
          echo "- settlements" >> $GITHUB_STEP_SUMMARY
          echo "- transactions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project ID:** \`$SUPABASE_PROJECT_REF\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Functions are now live and accessible via your Supabase project URL." >> $GITHUB_STEP_SUMMARY
