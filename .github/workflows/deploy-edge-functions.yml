name: Deploy Supabase Edge Functions

on:
  push:
    branches:
      - "main"
  workflow_dispatch:
    # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: Production
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Verify Supabase CLI
        run: |
          supabase --version
          echo "âœ… Supabase CLI installed successfully"

      - name: Verify required secrets
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "âŒ SUPABASE_ACCESS_TOKEN secret is not set"
            echo "Please add it in: Settings > Secrets and variables > Actions"
            exit 1
          fi
          if [ -z "$SUPABASE_PROJECT_REF" ]; then
            echo "âŒ SUPABASE_PROJECT_REF secret is not set"
            echo "Please add it in: Settings > Secrets and variables > Actions"
            echo "You can find your Project ID in your Supabase project settings"
            exit 1
          fi
          echo "âœ… Required secrets are configured"

      - name: Link to Supabase project
        run: |
          supabase link --project-ref $SUPABASE_PROJECT_REF
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Deploy all Edge Functions
        run: |
          echo "ðŸš€ Deploying Supabase Edge Functions..."
          supabase functions deploy --project-ref $SUPABASE_PROJECT_REF
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: List deployed functions
        run: |
          echo "ðŸ“‹ Deployed Edge Functions:"
          supabase functions list --project-ref $SUPABASE_PROJECT_REF || echo "Note: Function listing may require additional permissions"
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        continue-on-error: true

      - name: Deployment summary
        run: |
          echo "## âœ… Edge Functions Deployed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Supabase Edge Functions have been deployed to production." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed Functions:**" >> $GITHUB_STEP_SUMMARY
          echo "- activity" >> $GITHUB_STEP_SUMMARY
          echo "- balances" >> $GITHUB_STEP_SUMMARY
          echo "- group-members" >> $GITHUB_STEP_SUMMARY
          echo "- groups" >> $GITHUB_STEP_SUMMARY
          echo "- invitations" >> $GITHUB_STEP_SUMMARY
          echo "- settlements" >> $GITHUB_STEP_SUMMARY
          echo "- transactions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project ID:** \`$SUPABASE_PROJECT_REF\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Functions are now live and accessible via your Supabase project URL." >> $GITHUB_STEP_SUMMARY
